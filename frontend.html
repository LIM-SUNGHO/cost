<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‚¬ì „ì›ê°€ ìë™í™”</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css">
    <script>
        let stopwatchInterval;
        let startTime;

        function startStopwatch() {
            startTime = Date.now();  // í˜„ì¬ ì‹œê°„ ê¸°ë¡
            document.getElementById("stopwatch").innerText = "â³ ê²½ê³¼ ì‹œê°„: 0ì´ˆ";

            if (stopwatchInterval) {
                clearInterval(stopwatchInterval); // ê¸°ì¡´ ì¸í„°ë²Œ ì œê±°
            }

            // â³ 1ì´ˆë§ˆë‹¤ ê²½ê³¼ ì‹œê°„ì„ ê°±ì‹ 
            stopwatchInterval = setInterval(() => {
                let elapsedTime = Math.floor((Date.now() - startTime) / 1000);
                document.getElementById("stopwatch").innerText = `â³ ê²½ê³¼ ì‹œê°„: ${elapsedTime}ì´ˆ`;
            }, 1000);
        }

        function stopStopwatch() {
            clearInterval(stopwatchInterval);  // â¹ï¸ ìŠ¤í†±ì›Œì¹˜ ì¤‘ì§€
        }

        async function loadDataPreview() {
            try {
                let response = await fetch("http://127.0.0.1:8000/view-data");
                if (!response.ok) {
                    throw new Error(`HTTP ì˜¤ë¥˜! ìƒíƒœ ì½”ë“œ: ${response.status}`);
                }

                let html = await response.text();
                document.getElementById("dataPreview").innerHTML = html;

                // âœ… í…Œì´ë¸” ìŠ¤íƒ€ì¼ ì ìš© (ê²€ìƒ‰, ì •ë ¬, í˜ì´ì§• í™œì„±í™”)
                $(document).ready(function() {
                    $('.dataframe').DataTable({
                        "paging": true,
                        "searching": true,
                        "ordering": true,
                        "info": true,
                        "lengthMenu": [10, 25, 50, 100],
                        "language": {
                            "lengthMenu": "í˜ì´ì§€ë‹¹ _MENU_ ê°œì”© ë³´ê¸°",
                            "zeroRecords": "ğŸ” ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.",
                            "info": "ì´ _TOTAL_ ê°œ ì¤‘ _START_ - _END_",
                            "infoEmpty": "ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.",
                            "infoFiltered": "(ì´ _MAX_ ê°œ ì¤‘ ê²€ìƒ‰ë¨)",
                            "search": "ğŸ” ê²€ìƒ‰: ",
                            "paginate": {
                                "first": "ì²˜ìŒ",
                                "last": "ë§ˆì§€ë§‰",
                                "next": "ë‹¤ìŒ",
                                "previous": "ì´ì „"
                            }
                        }
                    });
                });

            } catch (error) {
                console.error("âŒ ë°ì´í„° ë¡œë”© ì˜¤ë¥˜:", error);
                document.getElementById("dataPreview").innerHTML = "<p>âŒ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>";
            }
        }

        async function uploadFiles() {
            let fileInput = document.getElementById("fileInput");
            let files = fileInput.files;
    
            if (files.length === 0) {
                alert("ğŸ“‚ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
                return;
            }
    
            let formData = new FormData();
            let uploadedFileList = document.getElementById("uploadedFileList");
            uploadedFileList.innerHTML = ""; // ê¸°ì¡´ ëª©ë¡ ì´ˆê¸°í™”
    
            for (let file of files) {
                formData.append("files", file);
    
                // í™”ë©´ì— ì—…ë¡œë“œëœ íŒŒì¼ ëª©ë¡ ì¶”ê°€
                let li = document.createElement("li");
                li.innerText = file.name;
                uploadedFileList.appendChild(li);
            }
    
            document.getElementById("status").innerText = "ğŸ“¤ íŒŒì¼ ì—…ë¡œë“œ ì¤‘...";
    
            try {
                let response = await fetch("http://127.0.0.1:8000/upload/", {
                    method: "POST",
                    body: formData
                });
    
                if (!response.ok) {
                    throw new Error(`HTTP ì˜¤ë¥˜! ìƒíƒœ ì½”ë“œ: ${response.status}`);
                }
    
                let result = await response.json();
                console.log("âœ… ì„œë²„ ì‘ë‹µ:", result);
    
                document.getElementById("status").innerText = result.message || "âœ… ì—…ë¡œë“œ ì™„ë£Œ!";
                listProcessedFiles(); // âœ… íŒŒì¼ ëª©ë¡ ê°±ì‹ 
                loadDataPreview();  // âœ… ì—…ë¡œë“œ í›„ ë°ì´í„° ìƒˆë¡œê³ ì¹¨
    
            } catch (error) {
                console.error("âŒ íŒŒì¼ ì—…ë¡œë“œ ì˜¤ë¥˜:", error);
                document.getElementById("status").innerText = "âŒ ì—…ë¡œë“œ ì‹¤íŒ¨!";
            }
        }

        async function runProcessing() {
            document.getElementById("status").innerText = "âš™ï¸ ì „ì²´ ë°ì´í„° ì²˜ë¦¬ ì¤‘...";
            startStopwatch();  // â³ ìŠ¤í†±ì›Œì¹˜ ì‹œì‘

            try {
                let response = await fetch("http://127.0.0.1:8000/run-processing/", {
                    method: "POST"
                });

                if (!response.ok) {
                    throw new Error(`HTTP ì˜¤ë¥˜! ìƒíƒœ ì½”ë“œ: ${response.status}`);
                }

                let result = await response.json();
                document.getElementById("status").innerText = result.message || "âœ… ë°ì´í„° ì²˜ë¦¬ ì™„ë£Œ!";
                
                stopStopwatch();  // â¹ï¸ ìŠ¤í†±ì›Œì¹˜ ì¤‘ì§€
                listProcessedFiles(); // âœ… íŒŒì¼ ëª©ë¡ ê°±ì‹ 
                loadDataPreview();  // âœ… ë°ì´í„° ìƒˆë¡œê³ ì¹¨

            } catch (error) {
                console.error("âŒ ë°ì´í„° ì²˜ë¦¬ ì˜¤ë¥˜:", error);
                document.getElementById("status").innerText = "âŒ ë°ì´í„° ì²˜ë¦¬ ì‹¤íŒ¨!";
                stopStopwatch();
            }
        }

        async function listProcessedFiles() {
            try {
                let response = await fetch("http://127.0.0.1:8000/list-results/");
                
                if (!response.ok) {
                    throw new Error(`HTTP ì˜¤ë¥˜! ìƒíƒœ ì½”ë“œ: ${response.status}`);
                }

                let result = await response.json();
                let fileList = document.getElementById("fileList");
                fileList.innerHTML = "";

                if (result.processed_files?.length > 0) {
                    result.processed_files.forEach(file => {
                        let li = document.createElement("li");
                        let a = document.createElement("a");
                        a.href = "http://127.0.0.1:8000/download/" + encodeURIComponent(file);
                        a.innerText = file;
                        a.download = file;
                        li.appendChild(a);
                        fileList.appendChild(li);
                    });
                } else {
                    fileList.innerHTML = "<li>ğŸš« ì²˜ë¦¬ëœ íŒŒì¼ ì—†ìŒ</li>";
                }
            } catch (error) {
                console.error("âŒ íŒŒì¼ ëª©ë¡ ê°€ì ¸ì˜¤ê¸° ì˜¤ë¥˜:", error);
                document.getElementById("status").innerText = "âŒ ì²˜ë¦¬ëœ íŒŒì¼ ëª©ë¡ì„ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.";
            }
        }

        // âœ… í˜ì´ì§€ ë¡œë“œ ì‹œ ë°ì´í„° ë¯¸ë¦¬ë³´ê¸° ë¡œë“œ
        document.addEventListener("DOMContentLoaded", () => {
            loadDataPreview();
            listProcessedFiles();
        });
    </script>

    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
        th { background-color: #f4f4f4; font-size: 16px; } /* í—¤ë” í¬ê¸° ìœ ì§€ */
        td { font-size: 14px; } /* ğŸ”½ ê¸°ì¡´ë³´ë‹¤ 2ë‹¨ê³„ ì‘ì€ í¬ê¸° */
        .empty-message { text-align: center; font-weight: bold; color: #888; margin-top: 10px; }
        .progress-container { width: 100%; background-color: #f3f3f3; border-radius: 5px; overflow: hidden; display: none; margin-top: 10px; }
        .progress-bar { width: 0%; height: 20px; background-color: #4caf50; text-align: center; color: white; line-height: 20px; }
    </style>
</head>
<body>
    <h2>íŒŒì¼ ì—…ë¡œë“œ ë° ë°ì´í„° ì²˜ë¦¬</h2>

    <input type="file" id="fileInput" multiple>
    <button onclick="uploadFiles()">ì—…ë¡œë“œ</button>
    <button onclick="runProcessing()">ì „ì²´ ë°ì´í„° ì²˜ë¦¬</button>
    <p id="status"></p>

    <h3>ğŸ“‚ ì—…ë¡œë“œëœ íŒŒì¼ ëª©ë¡</h3>
    <ul id="uploadedFileList"></ul>    

    <h3>ê²½ê³¼ ì‹œê°„</h3>
    <p id="stopwatch">â³ ê²½ê³¼ ì‹œê°„: 0ì´ˆ</p>    

    <h3>ì²˜ë¦¬ëœ íŒŒì¼ ë‹¤ìš´ë¡œë“œ</h3>
    <ul id="fileList"></ul>

    <h3>ğŸ“Š ë°ì´í„° ë¯¸ë¦¬ë³´ê¸°</h3>
    <div id="dataPreview">
        <p>ğŸ“¥ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
    </div>
</body>
</html>
